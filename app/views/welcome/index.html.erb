<%# 초기화면 재정의 %>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'welcome_dashboard', :plugin => 'daou_view_custom' %>
  <%= javascript_include_tag "chart.umd.min.js", :plugin => 'daou_view_custom' %>
  <%= javascript_include_tag "chartjs-plugin-datalabels.min.js", :plugin => 'daou_view_custom' %>
  <%= javascript_include_tag "dashboard.js", :plugin => 'daou_view_custom' %>
<% end %>

<% 
  # 서비스 객체 초기화
  dashboard_service = DaouViewCustom::DashboardStatsService.new(params)
  projects = dashboard_service.target_projects
  display_statuses = DaouViewCustom::DashboardStatsService.display_statuses
%>

<!-- 상단 통합 포털 섹션 -->
<%= Setting.welcome_text.html_safe %>

<!-- 하단 프로젝트 현황 차트 -->
<h2 class="dashboard-main-title">📊 프로젝트별 이슈처리 현황</h2>

<!-- 날짜 검색 폼 -->
<div class="date-filter-container">
  <form class="date-filter-form" method="get">
    <div class="filter-item">
      <label for="project_id">프로젝트 선택</label>
      <select name="project_id" id="project_id" class="filter-project-select">
        <option value="">전체</option>
        <% Project.visible.where(parent_id: nil).sorted.each do |p| %>
          <option value="<%= p.id %>" <%= 'selected' if params[:project_id].to_s == p.id.to_s %>><%= p.name %></option>
        <% end %>
      </select>
    </div>
    <div class="filter-item">
      <label for="start_date">시작일</label>
      <input class="datepicker-input" type="date" id="start_date" name="start_date" value="<%= dashboard_service.start_date %>" onkeydown="return false" onclick="this.showPicker()">
    </div>
    <span class="filter-separator">~</span>
    <div class="filter-item">
      <label for="end_date">종료일</label>
      <input class="datepicker-input" type="date" id="end_date" name="end_date" value="<%= dashboard_service.end_date %>" onkeydown="return false" onclick="this.showPicker()">
    </div>
    <button class="filter-submit-btn" type="submit">조회</button>
    <% if params[:start_date].present? || params[:end_date].present? || params[:project_id].present? %>
      <a class="filter-reset-link" href="<%= request.path %>">초기화</a>
    <% end %>
  </form>

  <div class="filter-info">
    <span class="filter-info-icon">ℹ️</span>
    일감의 <strong>생성일</strong> 기준 검색 (최대 365일)
  </div>
</div>

<div class="dashboard-container">
  <% if projects.any? %>
    <% projects.each do |project| %>
      <% stats = dashboard_service.stats_for_project(project) %>
      
      <div class="project-card">
        <div class="project-title" title="<%= project.name %>">
          <% if params[:project_id].blank? %>
            <%= link_to project.name, { controller: 'welcome', action: 'index', project_id: project.id, start_date: params[:start_date], end_date: params[:end_date] } %>
          <% else %>
            <%= link_to_project project %>
          <% end %>
        </div>

        <div class="chart-section">
          <% if stats[:total] > 0 %>
            <canvas id="chart-<%= project.id %>"></canvas>
          <% else %>
            <p class="no-data-msg">데이터 없음</p>
          <% end %>
        </div>

        <table class="stats-table">
          <thead>
          <tr>
            <th>합계</th>
            <th>신규</th>
            <th>진행</th>
            <th>완료</th>
            <th>보류</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>
              <%= link_to stats[:total], project_issues_path(project, set_filter: 1, f: ['status_id', 'created_on'], op: { status_id: '*', created_on: '><' }, v: { created_on: [dashboard_service.start_date, dashboard_service.end_date] }), class: 'clickable-count' %>
            </td>
            <% display_statuses.each do |status| %>
              <td>
                <% if status %>
                  <% count = stats[:counts][status.id] || 0 %>
                  <% if count > 0 %>
                    <%= link_to count, project_issues_path(project, set_filter: 1, f: ['status_id', 'created_on'], op: { status_id: '=', created_on: '><' }, v: { status_id: [status.id], created_on: [dashboard_service.start_date, dashboard_service.end_date] }), class: 'clickable-count' %>
                  <% else %>
                    <span class="stat-none">-</span>
                  <% end %>
                <% else %>
                  <span class="stat-na">-</span>
                <% end %>
              </td>
            <% end %>
          </tr>
          </tbody>
        </table>

        <% if stats[:total] > 0 %>
          <script>
            initDashboardChart(
              'chart-<%= project.id %>', 
              <%= raw stats[:chart_data][:labels].to_json %>, 
              <%= raw stats[:chart_data][:data].to_json %>, 
              <%= raw stats[:chart_data][:colors].to_json %>
            );
          </script>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p>표시할 프로젝트가 없습니다.</p>
  <% end %>
</div>
